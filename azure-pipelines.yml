# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
      - main
      - feature/Java

pool: Azure Pipelines

stages:
  - stage: Build
    jobs:
      - job: MavenBuild
        displayName: Maven Build
        steps:
        - task: Maven@3
          displayName: Maven Build
          inputs:
            mavenPomFile: 'pom.xml'
            mavenOptions: '-Xmx3072m'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '1.11'
            jdkArchitectureOption: 'x64'
            publishJUnitResults: true
            testResultsFiles: '**/surefire-reports/TEST-*.xml'
            goals: 'package'
        - task: ArchiveFiles@2
          displayName: Archive the Artifacts
          inputs:
            rootFolderOrFile: '$(Build.SourcesDirectory)/target'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
            replaceExistingArchive: true
        - task: PublishBuildArtifacts@1
          displayName: Publish Build Artifacts
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/target'
            ArtifactName: 'MavenBuildArtifact'
            publishLocation: 'Container'
            
  - stage: Linting

    jobs:

      - job: Linting_Java_App
        steps:

        - task: PowerShell@2
          displayName: Install and Run StyleLint
          inputs:
            targetType: 'inline'
            script: |
              Write-Host "=== INSTALL & RUN STYLELINT ==="

              # Move to repo root
              cd "$(Build.SourcesDirectory)"

              # Ensure Node exists
              if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
                  Write-Host "❌ Node.js is not installed on the agent."
                  exit 1
              }

              Write-Host "Initializing npm project..."
              npm init -y --silent

              Write-Host "Installing Stylelint and configs..."
              npm install --save-dev stylelint stylelint-config-standard stylelint-config-standard-scss stylelint-scss --silent

              Write-Host "Creating Stylelint configuration..."
              @'
              {
                "extends": [
                  "stylelint-config-standard",
                  "stylelint-config-standard-scss"
                ]
              }
              '@ | Out-File -FilePath ".stylelintrc.json" -Encoding utf8


              Write-Host "=== Searching CSS/SCSS files ==="

              # Detect CSS and SCSS anywhere in the repo
              $cssFiles = bash -c "find $(Build.SourcesDirectory) -type f \( -name '*.css' -o -name '*.scss' \)"

              if (-not $cssFiles) {
                  Write-Host "⚠ No CSS/SCSS files found. Showing directory tree..."
                  bash -c "ls -R $(Build.SourcesDirectory)"
                  exit 0   # Do NOT fail pipeline if no CSS exists
              }

              Write-Host "Found the following files:"
              Write-Host $cssFiles

              Write-Host "=== Running Stylelint ==="

              # Run stylelint against all found files
              bash -c "npx stylelint $(echo $cssFiles)"

              Write-Host "✅ Stylelint completed successfully."



  - stage: Deploy
    displayName: DeploytoTomcat
    jobs:
      - job: Deploy
        displayName: Copy War & Restart Tomcat
        steps:
        - task: DownloadBuildArtifacts@1
          displayName: Get the Artifacts
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'MavenBuildArtifact'
            itemPattern: 
            downloadPath: '$(Pipeline.Workspace)'
        - task: PowerShell@2
          displayName: Find WAR File
          inputs:
            targetType: 'inline'
            script: |
              Write-Host "=== Searching for WAR files ==="
              $artifactPath = "$(Pipeline.Workspace)/MavenBuildArtifact"
              Write-Host "Artifact path: $artifactPath"
              
              if (-not (Test-Path $artifactPath)) {
                Write-Error "Artifact path does not exist: $artifactPath"
                Write-Host "Available directories in Pipeline.Workspace:"
                Get-ChildItem -Path "$(Pipeline.Workspace)" -Directory | Format-Table Name
                exit 1
              }
              
              # List all files
              Write-Host "All files in artifact:"
              Get-ChildItem -Path $artifactPath -Recurse | Select-Object -First 20 | Format-Table Name, Extension, Length
              
              # Find WAR files
              $warFiles = Get-ChildItem -Path $artifactPath -Filter "*.war" -Recurse
              if ($warFiles.Count -eq 0) {
                Write-Warning "No WAR files found in artifact!"
                Write-Host "Looking for any JAR files instead..."
                $jarFiles = Get-ChildItem -Path $artifactPath -Filter "*.jar" -Recurse
                if ($jarFiles.Count -gt 0) {
                  Write-Host "Found JAR files instead:"
                  $jarFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }
                }
              } else {
                Write-Host "Found $($warFiles.Count) WAR file(s):"
                $warFiles | ForEach-Object { 
                  Write-Host "  - $($_.FullName)"
                }
              }
              
        - task: CopyFilesOverSSH@0
          displayName: Copy Files Over SSH
          inputs:
            sshEndpoint: 'sshSC'
            sourceFolder: '$(Pipeline.Workspace)/MavenBuildArtifact'
            contents: '**/*.war'
            targetFolder: '/opt/tomcat/webapps/'
            readyTimeout: '20000'
        - task: SSH@0
          displayName: Restart Tomcat
          inputs:
            sshEndpoint: 'sshSC'
            runOptions: 'inline'
            inline: |
              sudo systemctl restart tomcat
              echo "Tomcat restarted successfully."
            readyTimeout: '20000'