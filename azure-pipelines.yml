# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
  branches:
    include:
      - main
      - feature/Java

pool: Azure Pipelines

stages:
  - stage: Build
    jobs:
      - job: MavenBuild
        displayName: Maven Build
        steps:
        - task: Maven@3
          displayName: Maven Build
          inputs:
            mavenPomFile: 'pom.xml'
            mavenOptions: '-Xmx3072m'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '1.11'
            jdkArchitectureOption: 'x64'
            publishJUnitResults: true
            testResultsFiles: '**/surefire-reports/TEST-*.xml'
            goals: 'package'
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/target'
            ArtifactName: 'Maven Build Artifact'
            publishLocation: 'Container'

  - stage: Linting

    jobs:

      - job: Linting_Java_App
        steps:
        - task: PowerShell@2
          displayName: Install & Run Checkstyle
          inputs:
            targetType: 'inline'
            script: |
              Write-Host "=== VALIDATE JAVA INSTALLATION ==="
              if (-not (Get-Command java -ErrorAction SilentlyContinue)) {
                  Write-Error "Java is NOT installed. Please install Java on the agent."
                  exit 1
              }
        
              Write-Host "JAVA_HOME = $env:JAVA_HOME"
              java -version
        
              Write-Host "`n=== INSTALLING CHECKSTYLE ==="
              $workDir = "$env:AGENT_TEMPDIRECTORY/checkstyle"
              New-Item -ItemType Directory -Force -Path $workDir | Out-Null
        
              $checkstyleUrl = "https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.18.1/checkstyle-10.18.1-all.jar"
              $jarPath = "$workDir/checkstyle.jar"
        
              Write-Host "Downloading Checkstyle JAR..."
              Invoke-WebRequest -Uri $checkstyleUrl -OutFile $jarPath
              Write-Host "Checkstyle JAR downloaded: $jarPath"
        
              Write-Host "`nTesting Checkstyle..."
              java -jar $jarPath --version
        
              Write-Host "`n=== DOWNLOADING CHECKSTYLE CONFIG (google_checks.xml) ==="
              $configUrl = "https://raw.githubusercontent.com/checkstyle/checkstyle/checkstyle-10.18.1/src/main/resources/google_checks.xml"
              $configPath = "$(System.DefaultWorkingDirectory)/google_checks.xml"
        
              Invoke-WebRequest -Uri $configUrl -OutFile $configPath
              Write-Host "Config downloaded at: $configPath"
        
              Write-Host "`n=== RUNNING CHECKSTYLE ==="
              $srcFolder = "$(System.DefaultWorkingDirectory)/src"
        
              Write-Host "Source Folder: $srcFolder"
              Write-Host "Running Checkstyle audit..."
        
              java -jar $jarPath -c $configPath -f plain $srcFolder
        
              Write-Host "`n=== CHECKSTYLE COMPLETED ==="

  - stage: Deploy
    displayName: DeploytoTomcat
    jobs:
      - job: Deploy
        displayName: Copy War & Restart Tomcat
        steps:
        - task: DownloadBuildArtifacts@1
          displayName: Get the Artifacts
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'Maven Build Artifact'
            itemPattern: 
            downloadPath: '$(Pipeline.Workspace)'
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(Pipeline.Workspace)/Maven Build Artifact'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
            replaceExistingArchive: true
        - task: CopyFilesOverSSH@0
          displayName: Copy Files Over SSH
          inputs:
            sshEndpoint: 'sshSC'
            sourceFolder: '$(Pipeline.Workspace)/Maven Build Artifact'
            contents: '**/*.war'
            targetFolder: '/var/lib/tomcat10/webapps/'
            readyTimeout: '20000'
        - task: SSH@0
          displayName: Restart Tomcat
          inputs:
            sshEndpoint: 'sshSC'
            runOptions: 'inline'
            inline: |
              sudo systemctl restart tomcat10
                            echo "Tomcat restarted successfully."
            readyTimeout: '20000'